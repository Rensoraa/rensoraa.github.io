<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" type="image/x-icon" href="favicon.ico">
<title>Non-Farmer Steam Profiles</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>
<div class="container">
  <h1>Collected Steam Profiles</h1>
  <a>These people either bring no offer or play normal/Grief others on cross-off</a>
  <p class="counter" id="profileCount">0 accounts stored</p>

  <div class="input-box">
    <input type="text" id="input" placeholder="Search Steam ID or Vanity" />
    <button id="searchBtn">Search</button>
    <button id="resetBtn">Show All</button>
  </div>

  <div id="profilesList" class="profiles-list"></div>
  <p id="error" class="error hidden"></p>
</div>

<!-- Submit Button -->
<button class="submit-button" id="submitBtn">Submit ID</button>

<!-- Info popup -->
<div class="popup-overlay hidden" id="popupOverlay">
  <div class="custom-popup">
    <p>Send Steam IDs of trolls via Discord or contact me on Steam!<br>And I'll make sure they are listed here soon.</p>
    <button id="closePopup">Close</button>
  </div>
</div>

<!-- Reason popup -->
<div class="popup-overlay hidden" id="reasonOverlay">
  <div class="custom-popup">
    <p id="reasonText"></p>
    <button id="closeReason">Close</button>
  </div>
</div>

<!-- Submission popup -->
<div class="submission-overlay hidden" id="submissionOverlay">
  <div class="submission-popup">
    <h2>Submit a Steam ID</h2>
    <input type="text" id="steamIdInput" placeholder="Steam ID or Steam Profile Link" />
    <textarea id="reasonInput" rows="4" placeholder="Reason for submission"></textarea>
    <button id="submitFormBtn">Submit</button>
    <button id="closeSubmission">Cancel</button>
  </div>
</div>

<!-- Custom alert -->
<div class="custom-alert" id="customAlert"></div>

<script>
const workerUrl = "https://steam-api-proxy.itsnielsje.workers.dev";
const listContainer = document.getElementById("profilesList");
const error = document.getElementById("error");
const input = document.getElementById("input");
const searchBtn = document.getElementById("searchBtn");
const resetBtn = document.getElementById("resetBtn");
const profileCount = document.getElementById("profileCount");

let profilesData = [];
let allowedProfiles = [];

// Load profiles
async function loadProfiles() {
  try {
    const res = await fetch("profiles.json");
    allowedProfiles = await res.json();

    for (const entry of allowedProfiles) {
      const idOrVanity = typeof entry === "string" ? entry : entry.id;
      const reason = typeof entry === "object" && entry.reason ? entry.reason : "No reason provided";

      const isNumeric = /^\d+$/.test(idOrVanity);
      const param = isNumeric ? `steamid=${idOrVanity}` : `vanity=${idOrVanity}`;
      try {
        const r = await fetch(`${workerUrl}/?${param}`);
        const data = await r.json();

        if (data && data.steamid) {
          const div = document.createElement("div");
          div.classList.add("profile");
          div.dataset.key = idOrVanity.toLowerCase();

          let reasonHTML;
          if (reason.length > 60) {
            reasonHTML = `<span class="clickable-reason" data-reason="${reason}">Reason: Click here</span>`;
          } else {
            reasonHTML = `Reason: ${reason}`;
          }

          div.innerHTML = `
            <img src="${data.avatarfull}" alt="Avatar">
            <div class="info">
              <h2>${data.personaname}</h2>
              <p><strong>Steam ID:</strong> ${data.steamid}</p>
              <p><strong>${reasonHTML}</strong></p>
              <a href="${data.profileurl}" target="_blank">ðŸ”— View on Steam</a>
            </div>
          `;
          profilesData.push(div);
          listContainer.appendChild(div);
        }
      } catch (e) {
        console.error("Failed to load profile:", idOrVanity);
      }
    }

    profileCount.textContent = `${profilesData.length} accounts stored`;
  } catch (err) {
    console.error(err);
    error.textContent = "Failed to load profiles.json.";
    error.classList.remove("hidden");
  }
}

// Search & reset
function searchProfiles() {
  const query = input.value.trim().toLowerCase();
  listContainer.innerHTML = "";
  if (!query) {
    profilesData.forEach(card => listContainer.appendChild(card));
    return;
  }

  const matched = profilesData.filter(card => card.dataset.key.includes(query));

  if (matched.length === 0) {
    error.textContent = "No profile found in the database.";
    error.classList.remove("hidden");
  } else {
    error.classList.add("hidden");
    matched.forEach(card => listContainer.appendChild(card));
  }
}

function resetSearch() {
  input.value = "";
  listContainer.innerHTML = "";
  profilesData.forEach(card => listContainer.appendChild(card));
  error.classList.add("hidden");
}

searchBtn.addEventListener("click", searchProfiles);
resetBtn.addEventListener("click", resetSearch);
loadProfiles();

// Info popup
const infoButton = document.getElementById("infoButton");
const popupOverlay = document.getElementById("popupOverlay");
const closePopup = document.getElementById("closePopup");

infoButton?.addEventListener("click", () => popupOverlay.classList.remove("hidden"));
closePopup?.addEventListener("click", () => popupOverlay.classList.add("hidden"));
popupOverlay?.addEventListener("click", e => { if(e.target === popupOverlay) popupOverlay.classList.add("hidden"); });

// Reason popup
const reasonOverlay = document.getElementById("reasonOverlay");
const reasonText = document.getElementById("reasonText");
const closeReason = document.getElementById("closeReason");

document.addEventListener("click", (e) => {
  if(e.target.classList.contains("clickable-reason")) {
    reasonText.innerHTML = e.target.dataset.reason.replace(/\n/g, "<br>");
    reasonOverlay.classList.remove("hidden");
  }
});

closeReason.addEventListener("click", () => reasonOverlay.classList.add("hidden"));
reasonOverlay.addEventListener("click", e => { if(e.target === reasonOverlay) reasonOverlay.classList.add("hidden"); });

// Submission popup
const submitBtn = document.getElementById("submitBtn");
const submissionOverlay = document.getElementById("submissionOverlay");
const closeSubmission = document.getElementById("closeSubmission");
const submitFormBtn = document.getElementById("submitFormBtn");
const steamIdInput = document.getElementById("steamIdInput");
const reasonInput = document.getElementById("reasonInput");
const customAlert = document.getElementById("customAlert");

submitBtn.addEventListener("click", () => submissionOverlay.classList.remove("hidden"));
closeSubmission.addEventListener("click", () => submissionOverlay.classList.add("hidden"));
submissionOverlay.addEventListener("click", e => { if(e.target === submissionOverlay) submissionOverlay.classList.add("hidden"); });

function showAlert(msg, duration=3000) {
  customAlert.textContent = msg;
  customAlert.style.display = "block";
  setTimeout(() => { customAlert.style.display = "none"; }, duration);
}

// Submit form to Discord webhook with embed
submitFormBtn.addEventListener("click", async () => {
  const steamId = steamIdInput.value.trim();
  const reason = reasonInput.value.trim();

  if(!steamId || !reason) {
    showAlert("Please fill in both Steam ID/Link and Reason");
    return;
  }

  const webhookUrl = "https://discord.com/api/webhooks/1430636173612552265/A1aQbkqlBuRctnCjG54LvtrP1ldQFCV7x8S2BMc6Vidrl1QK8rw7Re-WK1lWj9Tcq1gj";

  const payload = {
    content: "<@929521121475313804>",
    embeds: [{
      title: "New Steam ID Submission",
      color: 0x005f9e, // Marine Blue
      fields: [
        { name: "Steam ID / Profile", value: steamId, inline: false },
        { name: "Reason", value: reason.replace(/\n/g, "\n"), inline: false }
      ],
      timestamp: new Date().toISOString()
    }]
  };

  try {
    const res = await fetch(webhookUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if(res.ok) {
      showAlert("Submission sent successfully!");
      steamIdInput.value = "";
      reasonInput.value = "";
      submissionOverlay.classList.add("hidden");
    } else {
      showAlert("Failed to send submission.");
    }
  } catch(err) {
    console.error(err);
    showAlert("Error sending submission.");
  }
});
</script>
</body>
</html>
